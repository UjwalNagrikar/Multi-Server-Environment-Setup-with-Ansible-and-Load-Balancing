---
- name: Update package cache
  apt:
    update_cache: yes
  become: yes

- name: Install packages
  package:
    name:
      - nginx
      - curl
    state: present
  become: yes

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes
  notify: restart nginx

- name: Configure Nginx load balancer
  template:
    src: nginx-lb.conf.j2
    dest: /etc/nginx/sites-available/loadbalancer
    backup: yes
  become: yes
  notify: restart nginx

- name: Enable load balancer configuration
  file:
    src: /etc/nginx/sites-available/loadbalancer
    dest: /etc/nginx/sites-enabled/loadbalancer
    state: link
  become: yes
  notify: restart nginx

- name: Configure firewall
  ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - 22
    - 80
    - 443
  become: yes

- name: Start and enable Nginx
  service:
    name: nginx
    state: started
    enabled: yes
  become: yes

- name: Test load balancer configuration
  uri:
    url: "http://{{ ansible_default_ipv4.address }}/health-lb"
    method: GET
  delegate_to: localhost
  ignore_errors: yes